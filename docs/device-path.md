# Путь устройства

Этот документ фиксирует текущую модель хранения deviceId и портативного ключа пути пользователя.

- **Источник правды** — `useDeviceStore().id`. Все запросы к защищённым API добавляют `x-device-id` из стора.
- При инициализации `getOrCreateDeviceId` синхронизирует cookie и `localStorage` и предупреждает о конфликте значений.
- `setDeviceId` в zustand сразу же обновляет cookie/`localStorage`, поэтому пересоздание устройства не требует дополнительных вызовов.
- Серверный резолвер (`src/lib/device/server.ts`) жёстко следует порядку `header > cookie > query > body` и логирует конфликтные случаи.

## Portable journey key

- Модуль `src/lib/journey.ts` создаёт коллекции Firestore `portable_journeys`, `portable_journey_devices` и `portable_journey_keys`.
- `identityKey` — случайная строка (6 блоков по 4 символа, алфавит без похожих символов). Хранится в виде SHA-256 хэша; в документе пути сохраняется только превью.
- Каждый путь имеет `primaryDeviceId`. При восстановлении новый `deviceId` привязывается как алиас, а данные (сообщения, ответы, статистика) мигрируют к основному идентификатору.
- `/api/journey/backup` генерирует новый ключ и возвращает актуальный статус пути; `/api/journey/attach` валидирует ключ, прикрепляет устройство и сливает локальную историю.
- `useDeviceStore().setId` по-прежнему источник правды. После успешной привязки API возвращают основной `deviceId`, и стор синхронизирует cookie/`localStorage`.
- `src/components/layout/Providers.tsx` после инициализации синхронизирует стор с сервером, чтобы alias-устройства быстро переключались на основной путь.

## Отладка

- Виджет `DevicePathWidget` дополнительно показывает эффективный deviceId, список прикреплённых устройств и превью ключа.
- `/api/messages/my` и `/api/stats/user` работают с каноническим идентификатором пути, а логи дополняются информацией о portable journey.
