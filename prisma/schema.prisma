 datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Device {
  id         String    @id @default(cuid())
  deviceHash String    @unique
  createdAt  DateTime  @default(now())
  lastSeenAt DateTime  @updatedAt

  messages   Message[]
  responses  Response[] @relation("ResponseAuthor")
  stats      UserStats?
}

model Message {
  id          String         @id @default(cuid())
  device      Device         @relation(fields: [deviceId], references: [id])
  deviceId    String
  body        String
  status      MessageStatus  @default(PUBLISHED)
  hasResponse Boolean        @default(false)
  createdAt   DateTime       @default(now())

  response    Response?
}

model Response {
  id             String    @id @default(cuid())
  message        Message   @relation(fields: [messageId], references: [id])
  messageId      String    @unique

  author         Device    @relation("ResponseAuthor", fields: [authorDeviceId], references: [id])
  authorDeviceId String

  body           String
  createdAt      DateTime  @default(now())
}

enum MessageStatus {
  PENDING
  PUBLISHED
  BLOCKED
}

model UserStats {
  device                 Device   @relation(fields: [deviceId], references: [id])
  deviceId               String   @id
  messagesSent           Int      @default(0)
  responsesSent          Int      @default(0)
  responsesReceived      Int      @default(0)
  lastResponseReceivedAt DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model GlobalStats {
  id             Int      @id @default(1)
  messagesTotal  Int      @default(0)
  responsesTotal Int      @default(0)
  devicesTotal   Int      @default(0)
}
